stages:
  - build
  - qa

variables:
  MYSQL_ROOT_PASSWORD: mypass
  DATABASE_URL: 'mysql://root:mypass@mariadb:3306/mydb?serverVersion=mariadb-10.5.9'

services:
  - mariadb:10.5.9

build:
  stage: build
  image: lvo9/demo
  cache:
    key:
      files:
        - composer.lock
    paths:
      - vendor/
      - bin/.phpunit
  script:
    - composer install
    - bin/phpunit install
  artifacts:
    paths:
      - vendor
      - bin/.phpunit

test:
  stage: qa
  image: lvo9/demo
  before_script:
    - bin/console doctrine:database:create
    - bin/console doctrine:migrations:migrate -n
    - bin/console doctrine:fixtures:load -n
  script: php -d memory_limit=-1 bin/phpunit -v

cs:
  stage: qa
  image: lvo9/demo
  script:
    - vendor/bin/php-cs-fixer fix --dry-run src
    - php -d memory_limit=-1 vendor/bin/phpstan analyse src